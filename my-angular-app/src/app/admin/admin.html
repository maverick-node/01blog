<!-- admin.component.html – FINAL 2025 ADMIN PANEL – NO ERRORS -->
<div class="admin-wrapper">

  <!-- HEADER -->
  <header class="admin-header">
    <h1>Admin Panel</h1>
    <div class="header-actions">
      <button mat-stroked-button (click)="router.navigate(['/dashboard'])">
        <mat-icon>dashboard</mat-icon> Dashboard
      </button>
      <button mat-raised-button color="primary" (click)="loadUsers()">
        <mat-icon>refresh</mat-icon> Refresh Users
      </button>
      <button mat-raised-button color="accent" (click)="loadPosts()">
        <mat-icon>refresh</mat-icon> Refresh Posts
      </button>
    </div>
  </header>

  <!-- TOAST -->
  <div class="toast-container">
    <div *ngIf="errorMessage" class="toast error" [class.show]="errorMessage">
      <mat-icon>error</mat-icon>
      <span>{{ errorMessage }}</span>
      <button mat-icon-button (click)="errorMessage = ''">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="stats-grid">
    <mat-card class="stat-card purple">
      <mat-card-content><div class="stat-icon"><mat-icon>block</mat-icon></div>
        <div class="stat-info"><div class="stat-label">Banned Users</div>
          <div class="stat-value">{{ bannedUsersCount }}</div></div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card blue">
      <mat-card-content><div class="stat-icon"><mat-icon>article</mat-icon></div>
        <div class="stat-info"><div class="stat-label">Total Posts</div>
          <div class="stat-value">{{ postsCount }}</div></div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card green">
      <mat-card-content><div class="stat-icon"><mat-icon>people</mat-icon></div>
        <div class="stat-info"><div class="stat-label">Total Users</div>
          <div class="stat-value">{{ usersCount }}</div></div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card orange">
      <mat-card-content><div class="stat-icon"><mat-icon>flag</mat-icon></div>
        <div class="stat-info"><div class="stat-label">Reports</div>
          <div class="report">
            <span class="pending">Pending: {{ unsolvedReports.length }}</span>
            <span class="done">Solved: {{ solvedReports.length }}</span>
          </div></div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- ALL USERS -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title><mat-icon>people</mat-icon> All Users</mat-card-title>
      <mat-card-subtitle>{{ users.length || 0 }} users</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="users" class="mat-elevation-z2">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> ID </th>
          <td mat-cell *matCellDef="let i = index"> {{ i + 1 }} </td>
        </ng-container>
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef> Username </th>
          <td mat-cell *matCellDef="let user"> {{ user.username }} </td>
        </ng-container>
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef> Email </th>
          <td mat-cell *matCellDef="let user"> {{ user.mail }} </td>
        </ng-container>
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef> Role </th>
          <td mat-cell *matCellDef="let user">
            <span class="role-chip" [class.admin]="user.role === 'admin'">{{ user.role }}</span>
          </td>
        </ng-container>
        <ng-container matColumnDef="age">
          <th mat-header-cell *matHeaderCellDef> Age </th>
          <td mat-cell *matCellDef="let user"> {{ user.age || '-' }} </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let user">
            <button mat-icon-button [color]="user.banned ? 'warn' : 'primary'"
                    (click)="confirmUserAction(user.username, user.banned ? 'unban' : 'ban')"
                    matTooltip="{{ user.banned ? 'Unban' : 'Ban' }} user">
              <mat-icon>{{ user.banned ? 'lock_open' : 'lock' }}</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="confirmUserAction(user.username, 'delete')" matTooltip="Delete user">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['id','username','email','role','age','actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['id','username','email','role','age','actions']"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <!-- REPORTS MANAGEMENT -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title><mat-icon>flag</mat-icon> Reports Management</mat-card-title>
      <mat-card-subtitle>{{ unsolvedReports.length }} pending</mat-card-subtitle>
    </mat-card-header>

    <mat-tab-group animationDuration="300ms">
      <!-- PROFILE REPORTS -->
      <mat-tab label="Profile Reports ({{ reportedUsers.length || 0}})">
        <div class="tab-content">
          <table mat-table [dataSource]="reportedUsers" class="mat-elevation-z2">
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef> ID </th>
              <td mat-cell *matCellDef="let r"> {{ r.id }} </td>
            </ng-container>
            <ng-container matColumnDef="reporter">
              <th mat-header-cell *matHeaderCellDef> Reporter </th>
              <td mat-cell *matCellDef="let r"> {{ r.reporterName }} </td>
            </ng-container>
            <ng-container matColumnDef="target">
              <th mat-header-cell *matHeaderCellDef> Target User </th>
              <td mat-cell *matCellDef="let r"> {{ r.targetUserName }} </td>
            </ng-container>
            <ng-container matColumnDef="reason">
              <th mat-header-cell *matHeaderCellDef> Reason </th>
              <td mat-cell *matCellDef="let r"> {{ r.reason }} </td>
            </ng-container>
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef> Date </th>
              <td mat-cell *matCellDef="let r"> {{ r.createdAt | date:'short' }} </td>
            </ng-container>
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Actions </th>
              <td mat-cell *matCellDef="let r">
                <button mat-icon-button color="primary" (click)="confirmResolveReport(r.id)" matTooltip="Mark as resolved">
                  <mat-icon>check_circle</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="confirmUserAction(r.targetUserName, 'ban')" matTooltip="Ban user">
                  <mat-icon>block</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="confirmUserAction(r.targetUserName, 'delete')" matTooltip="Delete user">
                  <mat-icon>person_remove</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['id','reporter','target','reason','date','actions']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['id','reporter','target','reason','date','actions']"></tr>
          </table>
        </div>
      </mat-tab>

      <!-- POST REPORTS -->
      <mat-tab label="Post Reports ({{ reportedPosts.length }})">
        <div class="tab-content">
          <table mat-table [dataSource]="reportedPosts" class="mat-elevation-z2">
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef> ID </th>
              <td mat-cell *matCellDef="let p"> {{ p.id }} </td>
            </ng-container>
            <ng-container matColumnDef="postId">
              <th mat-header-cell *matHeaderCellDef> Post ID </th>
              <td mat-cell *matCellDef="let p"> {{ p.reportedPostId }} </td>
            </ng-container>
            <ng-container matColumnDef="reporter">
              <th mat-header-cell *matHeaderCellDef> Reporter </th>
              <td mat-cell *matCellDef="let p"> {{ p.reporterName }} </td>
            </ng-container>
            <ng-container matColumnDef="reason">
              <th mat-header-cell *matHeaderCellDef> Reason </th>
              <td mat-cell *matCellDef="let p"> {{ p.reason }} </td>
            </ng-container>
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef> Date </th>
              <td mat-cell *matCellDef="let p"> {{ p.createdAt | date:'short' }} </td>
            </ng-container>
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Actions </th>
              <td mat-cell *matCellDef="let p">
                <button mat-icon-button color="primary" (click)="confirmResolveReport(p.id)" matTooltip="Mark as resolved">
                  <mat-icon>check_circle</mat-icon>
                </button>
                <button mat-icon-button 
                        [color]="p.hidden ? 'primary' : 'accent'"
                        (click)="confirmToggleVisibility(p.reportedPostId, p.hidden, 'reports')"
                        [matTooltip]="p.hidden ? 'Unhide post' : 'Hide post'">
                  <mat-icon>{{ p.hidden ? 'visibility' : 'visibility_off' }}</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="confirmDeletePost(p.reportedPostId)" matTooltip="Delete post">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['id','postId','reporter','reason','date','actions']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['id','postId','reporter','reason','date','actions']"></tr>
          </table>
        </div>
      </mat-tab>

      <!-- SOLVED REPORTS -->
      <mat-tab label="Solved ({{ solvedReports.length }})">
        <div class="tab-content">
          <table mat-table [dataSource]="solvedReports" class="mat-elevation-z2">
            <ng-container matColumnDef="id"><th mat-header-cell *matHeaderCellDef> ID </th><td mat-cell *matCellDef="let s"> {{ s.id }} </td></ng-container>
            <ng-container matColumnDef="type"><th mat-header-cell *matHeaderCellDef> Type </th>
              <td mat-cell *matCellDef="let s">
                <mat-chip [color]="s.targetUserName ? 'primary' : 'accent'" selected>
                  {{ s.reportedPostId ? 'User' : 'Post' }}
                </mat-chip>
              </td>
            </ng-container>
            <ng-container matColumnDef="target"><th mat-header-cell *matHeaderCellDef> Target </th>
              <td mat-cell *matCellDef="let s"> {{ s.targetUserName || s.reportedPostId }} </td>
            </ng-container>
            <ng-container matColumnDef="reporter"><th mat-header-cell *matHeaderCellDef> Reporter </th><td mat-cell *matCellDef="let s"> {{ s.reporterName }} </td></ng-container>
            <ng-container matColumnDef="reason"><th mat-header-cell *matHeaderCellDef> Reason </th><td mat-cell *matCellDef="let s"> {{ s.reason }} </td></ng-container>
            <ng-container matColumnDef="date"><th mat-header-cell *matHeaderCellDef> Resolved </th><td mat-cell *matCellDef="let s"> {{ s.createdAt | date:'short' }} </td></ng-container>

            <tr mat-header-row *matHeaderRowDef="['id','type','target','reporter','reason','date']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['id','type','target','reporter','reason','date']"></tr>
          </table>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-card>

  <!-- ALL POSTS — HIDE/UNHIDE TOGGLE -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title><mat-icon>article</mat-icon> All Posts</mat-card-title>
      <mat-card-subtitle>{{ posts.length || 0 }} posts</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="posts" class="mat-elevation-z2">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> ID </th>
          <td mat-cell *matCellDef="let p"> {{ p.id }} </td>
        </ng-container>
        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef> Title </th>
          <td mat-cell *matCellDef="let p"> {{ p.title }} </td>
        </ng-container>
        <ng-container matColumnDef="author">
          <th mat-header-cell *matHeaderCellDef> Author </th>
          <td mat-cell *matCellDef="let p"> {{ p.author }} </td>
        </ng-container>
        <ng-container matColumnDef="content">
          <th mat-header-cell *matHeaderCellDef> Content </th>
          <td mat-cell *matCellDef="let p">
            {{ (p.content || '').slice(0, 60) }}{{ p.content?.length > 60 ? '...' : '' }}
          </td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let p">
            <mat-chip [color]="p.hidden ? 'warn' : 'primary'" selected>
              {{ p.hidden ? 'Hidden' : 'Visible' }}
            </mat-chip>
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let p">
            <button mat-icon-button 
                    [color]="p.hidden ? 'primary' : 'accent'"
                    (click)="confirmToggleVisibility(p.id, p.hidden, 'not-reports')"
                    [matTooltip]="p.hidden ? 'Unhide post' : 'Hide post'">
              <mat-icon>{{ p.hidden ? 'visibility' : 'visibility_off' }}</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="confirmDeletePost(p.id)" matTooltip="Delete post">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['id','title','author','content','status','actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['id','title','author','content','status','actions']"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <!-- GLOBAL CONFIRM DIALOG -->
  <div class="confirm-overlay" *ngIf="confirmDialog.show" (click)="confirmDialog.show = false">
    <div class="confirm-box" (click)="$event.stopPropagation()">
      <div class="confirm-header">
        <mat-icon color="warn" class="warn-icon">warning</mat-icon>
        <h3>{{ confirmDialog.title }}</h3>
      </div>
      <p class="confirm-message" [innerHTML]="confirmDialog.message"></p>
      <div class="confirm-actions">
        <button mat-button (click)="confirmDialog.show = false">Cancel</button>
        <button mat-raised-button [color]="confirmDialog.color" (click)="confirmDialog.action()">
          <mat-icon>{{ confirmDialog.icon }}</mat-icon>
          {{ confirmDialog.confirmText }}
        </button>
      </div>
    </div>
  </div>
</div>