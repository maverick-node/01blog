<!-- dashboard.component.html – FINAL 2025 (GLOBAL REPORT BOX FIXED) -->
<div class="dashboard-wrapper">
  <mat-sidenav-container class="sidenav-container" autosize fullscreen>

    <!-- LEFT SIDEBAR -->
    <mat-sidenav #sidenav mode="side" opened class="left-sidenav" fixedInViewport>
      <div class="logo-container">
        <svg width="56" height="56" viewBox="0 0 200 200" class="logo-svg">
          <defs>
            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#8b5cf6" />
              <stop offset="100%" stop-color="#3b82f6" />
            </linearGradient>
          </defs>
          <rect x="30" y="30" width="140" height="140" rx="40" fill="url(#grad1)" />
          <text
            x="100"
            y="125"
            font-size="110"
            font-weight="bold"
            fill="white"
            text-anchor="middle"
            dominant-baseline="middle"
          >
            B
          </text>
        </svg>
        <div class="logo-text">BlogFlow</div>
      </div>

      <div class="sidebar-user">
        <div
          class="sidebar-avatar"
          [style.background-image]="'url(' + getAvatarUrl(username) + ')'"
        ></div>
        <div class="user-info-text">
          <div class="username-sidebar">{{ username }}</div>
          <div class="role-badge" [class.admin]="userRole === 'admin'">
            {{ userRole === 'admin' ? 'Admin' : 'Member' }}
          </div>
        </div>
      </div>

      <mat-nav-list>
        <a mat-list-item routerLinkActive="active" [routerLink]="['/dashboard']">
          <mat-icon class="right">dashboard</mat-icon>
          <span class="nav-text-right">Dashboard</span>
        </a>
        <a mat-list-item (click)="viewProfile()">
          <mat-icon class="right">person</mat-icon>
          <span class="nav-text-right">Profile</span>
        </a>
        <a mat-list-item *ngIf="userRole === 'admin'" (click)="goToAdminPanel()">
          <mat-icon class="right">shield</mat-icon>
          <span class="nav-text-right">Admin</span>
        </a>
        <mat-divider></mat-divider>
        <a mat-list-item (click)="logout()">
          <mat-icon class="right" color="white">logout</mat-icon>
          <span class="nav-text-right">Logout</span>
        </a>
      </mat-nav-list>
    </mat-sidenav>

    <!-- MAIN CONTENT -->
    <mat-sidenav-content class="main-content-area">
      <!-- TOPBAR -->
      <header class="topbar">
        <button mat-icon-button (click)="sidenav.toggle()">
          <mat-icon>menu</mat-icon>
        </button>
        <h1>BlogFlow</h1>
        <button
          mat-icon-button
          [matBadge]="unreadCount > 0 ? unreadCount : null"
          matBadgeColor="warn"
          matBadgeSize="small"
          (click)="toggleNotifications()"
        >
          <mat-icon>notifications</mat-icon>
        </button>
      </header>

      <!-- NOTIFICATION POPUP -->
      <div class="notification-popup" *ngIf="showPopup">
        <div class="notifications-dropdown">
          <div class="notifications-header">
            <h3>Notifications</h3>
          </div>
          <div *ngIf="!notifications || notifications.length === 0" class="no-notifications">
            <mat-icon>notifications_off</mat-icon>
            <p>No new notifications</p>
          </div>
          <ul class="notifications-list" *ngIf="notifications?.length">
            <li
              *ngFor="let n of notifications"
              class="notification-item"
              [class.unread]="!n.read"
              (click)="markRead(n.id)"
            >
              <div
                class="notification-avatar"
                [style.background-image]="'url(' + getAvatarUrl(n.username) + ')'"
              ></div>
              <div class="notification-content">
                <div class="notification-username">{{ n.username }}</div>
                <div class="notification-message">{{ n.message }}</div>
                <div class="timestamp">{{ n.timestamp || 'Just now' }}</div>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- HORIZONTAL USERS BAR -->
      <div class="users-horizontal-bar">
        <button mat-icon-button (click)="scrollUsersLeft()" class="scroll-btn left">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <div class="users-scroll-container" #usersScroll>
          <div class="user-bubble" *ngFor="let user of allusernames" (click)="goToUser(user)">
            <div
              class="user-avatar-circle"
              [style.background-image]="'url(' + getAvatarUrl(user) + ')'"
            >
              <mat-icon class="online-dot">circle</mat-icon>
            </div>
            <span class="username-label">{{ user }}</span>
          </div>
        </div>
        <button mat-icon-button (click)="scrollUsersRight()" class="scroll-btn right">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>

      <!-- SCROLLABLE FEED -->
      <div class="scrollable-feed">
        <main class="page-content">
          <!-- FLOATING TOAST NOTIFICATIONS – ALWAYS VISIBLE WHEN SCROLLING -->
          <div class="toast-container">
            <div
              *ngIf="errorMessage"
              class="toast-notification error"
              [class.show]="errorMessage"
              (click)="errorMessage = ''"
            >
              <mat-icon>error_outline</mat-icon>
              <span>{{ errorMessage }}</span>
              <button mat-icon-button class="close-toast" (click)="errorMessage = ''">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
          <!-- CREATE POST -->
          <section class="create-post-section">
            <h2>Create New Post</h2>
            <div class="create-post-form">
              <input
                type="text"
                [(ngModel)]="newPost.title"
                placeholder="Title..."
                class="post-input"
              />
              <textarea
                [(ngModel)]="newPost.content"
                placeholder="Share something awesome..."
                class="post-textarea"
              ></textarea>
              <input
                type="file"
                #fileInput
                multiple
                (change)="onFilesSelected($event)"
                accept="image/*,video/*"
                style="display: none"
              />
              <button
                mat-raised-button
                color="primary"
                (click)="fileInput.click()"
                style="margin: 12px 0"
              >
                <mat-icon>add_photo_alternate</mat-icon>
                {{ selectedFiles.length > 0 ? selectedFiles.length + ' selected' : 'Add media' }}
              </button>
              <button mat-raised-button color="primary" (click)="createPost()">
                <mat-icon>add_circle</mat-icon> Publish
              </button>
            </div>
          </section>

          <!-- POSTS -->
          <section class="posts-section">
            <div class="posts-list" *ngIf="posts.length; else noPosts">
              <mat-card class="post-card" *ngFor="let post of posts">
                <mat-card-header>
                  <div
                    mat-card-avatar
                    class="avatar-icon"
                    [style.background-image]="'url(' + getAvatarUrl(post.author) + ')'"
                  ></div>
                  <mat-card-title>{{ post.title }}</mat-card-title>
                  <mat-card-subtitle
                    >{{ post.author }} •
                    {{ post.createdAt | date : 'mediumDate' }}</mat-card-subtitle
                  >
                </mat-card-header>

                <mat-card-content>
                  <p class="post-content">{{ post.content }}</p>

                  <div class="media-grid" *ngIf="post.mediaPaths?.length > 0">
                    <div
                      class="media-item"
                      *ngFor="let path of post.mediaPaths; let i = index"
                      (click)="openMediaPreview(path, post.mediaTypes[i])"
                    >
                      <img
                        *ngIf="post.mediaTypes[i]?.startsWith('image')"
                        [src]="'http://localhost:8080' + path"
                        class="post-media"
                      />
                      <div class="video-container" *ngIf="post.mediaTypes[i]?.startsWith('video')">
                        <video
                          [src]="'http://localhost:8080' + path"
                          class="post-media"
                          preload="metadata"
                        ></video>
                        <div class="play-overlay"><mat-icon>play_circle</mat-icon></div>
                      </div>
                    </div>
                  </div>
                </mat-card-content>

                <!-- ACTIONS -->
                <mat-card-actions class="post-actions">
                  <button mat-icon-button (click)="likePost(post.id)">
                    <mat-icon [style.color]="likedPosts[post.id] ? '#e11d48' : '#666'">
                      {{ likedPosts[post.id] ? 'favorite' : 'favorite_border' }}
                    </mat-icon>
                    <span class="action-count">{{ likeCounts[post.id] || 0 }}</span>
                  </button>

                  <button mat-button color="primary" (click)="toggleComments(post.id)">
                    <mat-icon>{{
                      showComments[post.id] ? 'keyboard_arrow_up' : 'keyboard_arrow_down'
                    }}</mat-icon>
                    {{ (comments[post.id] || []).length }} Comments
                  </button>

                  <span class="spacer"></span>

                  <!-- REPORT BUTTON -->
                  <button
                    *ngIf="username !== post.author"
                    mat-icon-button
                    color="warn"
                    (click)="openReportBox(post.id)"
                  >
                    <mat-icon>flag</mat-icon>
                  </button>
                </mat-card-actions>

                <mat-divider></mat-divider>

                <!-- COMMENTS -->
                <div class="comments-section" *ngIf="showComments[post.id]">
                  <div class="comment-input-row">
                    <mat-form-field appearance="outline" class="comment-field">
                      <textarea
                        matInput
                        rows="2"
                        [(ngModel)]="newComment[post.id]"
                        placeholder="Add a comment..."
                      ></textarea>
                    </mat-form-field>
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="addComment(post.id)"
                      [disabled]="!newComment[post.id]?.trim()"
                    >
                      <mat-icon>send</mat-icon>
                    </button>
                  </div>

                  <div class="comments-list">
                    <div class="comment-item" *ngFor="let c of comments[post.id]">
                      <div
                        class="comment-avatar"
                        [style.background-image]="'url(' + getAvatarUrl(c.username) + ')'"
                      ></div>
                      <div class="comment-body">
                        <strong>{{ c.username }}</strong>
                        <p>{{ c.comment }}</p>
                        <small>{{ c.createdAt | date : 'short' }}</small>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-card>
            </div>

            <ng-template #noPosts>
              <div class="no-data">
                <mat-icon>info</mat-icon>
                <p>No posts yet. Start posting!</p>
              </div>
            </ng-template>
          </section>
        </main>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>

  <!-- FULL SCREEN MEDIA PREVIEW -->
  <div class="media-preview-overlay" *ngIf="previewUrl" (click)="closePreview()">
    <div class="media-preview-container" (click)="$event.stopPropagation()">
      <button mat-icon-button class="close-preview" (click)="closePreview()">
        <mat-icon>close</mat-icon>
      </button>
      <img *ngIf="previewType?.startsWith('image')" [src]="previewUrl"  class="full-media" />
      <video
       *ngIf="previewType?.startsWith('video')"
        [src]="previewUrl"
       
        class="full-media"
        controls
        autoplay
        loop
          crossorigin="anonymous">

      ></video>
    </div>
  </div>

  <!-- GLOBAL REPORT BOX – ALWAYS CENTERED & VISIBLE -->
  <div class="global-report-overlay" *ngIf="showReportBox" (click)="showReportBox = false">
    <div class="global-report-box" (click)="$event.stopPropagation()">
      <div class="report-header">
        <mat-icon color="warn">warning</mat-icon>
        <h3>Report Post #{{ currentPostId }}</h3>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Reason (optional)</mat-label>
        <textarea
          matInput
          rows="4"
          [(ngModel)]="reportReason"
          placeholder="Why are you reporting this post?"
        ></textarea>
      </mat-form-field>

      <div class="report-actions">
        <button mat-button (click)="showReportBox = false">Cancel</button>
        <button mat-raised-button color="warn" (click)="sendReport()">
          <mat-icon>flag</mat-icon> Report Post
        </button>
      </div>
    </div>
  </div>
</div>
